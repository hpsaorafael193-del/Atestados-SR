<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Atestado Médico - Hospital São Rafael</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --accent:#542412;
      --accent-hover:#3d0f00;
      --bg:#f7f3ef;
      --card:#fffaf6;
    }
    body{
      font-family:Inter, system-ui, Roboto, Arial;
      margin:0;
      background:var(--bg);
      color:var(--accent-hover);
      padding:12px;
    }
    .wrap{
      max-width:1200px;
      margin:28px auto;
      padding:20px;
      display:grid;
      grid-template-columns: minmax(300px, 400px) 1fr;
      gap:18px;
      width:100%;
    }
    .panel{
      background:var(--card);
      border-radius:12px;
      padding:18px;
      box-shadow:0 8px 20px rgba(12,15,30,0.10);
    }
    h1{ font-size:18px; margin:0 0 12px; color:var(--accent-hover); }
    label{ display:block; font-size:13px; margin:10px 0 6px; color:#2b2b2b; }
    input[type=text], input[type=date], input[type=number], textarea{ 
      width:100%; padding:8px 10px; border:1px solid #d7c9b8;
      border-radius:8px; font-size:14px; background:#fff; color:#1a1a1a;
    }
    textarea{ min-height:100px; resize:vertical; }
    button{ 
      background: var(--accent); color:#fff; border:none; padding:10px 14px; 
      border-radius:10px; font-weight:600; cursor:pointer; transition:background .2s ease;
    }
    button:hover{ background:var(--accent-hover); }
    .controls{ display:flex; gap:8px; margin-top:12px; flex-wrap:wrap; }
    .preview{ padding:32px; display:flex; justify-content:center; align-items:flex-start; }
    .paper{ 
      width:100%; max-width:900px; padding:40px; border:1px solid #e0d6c8; 
      background:#fffaf6; border-radius:12px; position:relative; box-shadow:0 8px 20px rgba(12,15,30,0.08);
      overflow:hidden;
    }
    /* watermark behind content */
    .paper::before{
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      width: 500px;
      height: 500px;
      background: url(background/fundo.png) no-repeat center center;
      background-size: contain;
      opacity: 0.08;
      transform: translate(-50%, -50%);
      pointer-events: none;
      z-index: 0;
    }
    .paper * { position: relative; z-index: 1; }
    .meta{ font-size:13px; color:#3a3a3a; margin-top:6px; }
    .sig{ height:70px; margin-top:20px; position:relative; }
    .sig img{ max-width:200px; height:auto; position:absolute; bottom:0; right:0; }
    @media (max-width:900px){ .wrap { grid-template-columns:1fr; } .paper{ padding:24px; } }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <h1>Atestado Médico</h1>

      <label>Nome do paciente</label>
      <input id="patientName" type="text" placeholder="Nome completo" />

      <label>Passaporte</label>
      <input id="document" type="text" placeholder="Documento" />

      <label>Data do atendimento</label>
      <input id="issueDate" type="date" />

      <label>Dias de afastamento</label>
      <input id="daysOff" type="number" min="0" value="0" />

      <label>Diagnóstico / Observações</label>
      <textarea id="notes" placeholder="Ex: paciente apresenta sintomas gripais..."></textarea>

      <label>Nome do médico</label>
      <input id="doctorName" type="text" placeholder="Nome do médico" />

      <label>CRM</label>
      <input id="crm" type="text" placeholder="CRM 12345-SP" />

      <label>Assinatura (PNG)</label>
      <input id="signatureUpload" type="file" accept="image/png, image/jpeg" />

      <div class="controls">
        <button id="updateBtn">Atualizar</button>
        <button id="savePngBtn">Salvar como PNG</button>
        <button id="clearBtn">Limpar</button>
      </div>
      <div class="hint" style="margin-top:8px;color:#555;font-size:13px;">Abra este arquivo direto (file://) ou via servidor local. A exportação funciona offline.</div>
    </div>

    <div class="panel preview">
      <div id="paper" class="paper">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <strong style="color:var(--accent-hover);">Hospital São Rafael</strong>
            <div class="meta">Sandy Shores - Zancudo Avenue</div>
          </div>
          <div class="meta" id="documentDate">Data: --/--/----</div>
        </div>

        <hr style="margin:14px 0;border:none;border-top:1px solid #ddd" />

        <p>Atesto, para os devidos fins, que <strong id="pNamePreview">[Nome do paciente]</strong>,
        portador(a) do documento <span id="pDocPreview">[Documento]</span>,
        foi atendido(a) nesta data <span id="pDatePreview">[dd/mm/aaaa]</span>
        e necessita de <strong id="pDaysPreview">0</strong> dia(s) de afastamento.</p>

        <p id="pNotesPreview">[Observações e diagnóstico]</p>

        <div style="margin-top:28px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <div id="doctorPreview">Nome do médico</div>
            <div class="meta" id="crmPreview">CRM: 000000</div>
          </div>
          <div class="sig">
            <img id="signaturePreview" src="" alt="Assinatura" style="display:none;" />
          </div>
        </div>

        <div style="margin-top:18px;font-size:12px;color:#555">
          Este atestado é emitido com base no atendimento clínico realizado.
          O período de afastamento indicado é o necessário para recuperação, conforme avaliação médica.
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const patientName = document.getElementById('patientName');
    const documentInput = document.getElementById('document');
    const issueDate = document.getElementById('issueDate');
    const daysOff = document.getElementById('daysOff');
    const notes = document.getElementById('notes');
    const doctorName = document.getElementById('doctorName');
    const crm = document.getElementById('crm');
    const documentDate = document.getElementById('documentDate');
    const signatureUpload = document.getElementById('signatureUpload');
    const signaturePreview = document.getElementById('signaturePreview');
    const observacoesTexto = document.getElementById('observacoes').value || '—';
      previewObservacoes.innerHTML = observacoesTexto.replace(/\n/g, '<br>');
    const pNamePreview = document.getElementById('pNamePreview');
    const pDocPreview = document.getElementById('pDocPreview');
    const pDatePreview = document.getElementById('pDatePreview');
    const pDaysPreview = document.getElementById('pDaysPreview');
    const pNotesPreview = document.getElementById('pNotesPreview');
    const doctorPreview = document.getElementById('doctorPreview');
    const crmPreview = document.getElementById('crmPreview');

    function formatDateBR(iso) {
      if (!iso) return '--/--/----';
      const [year, month, day] = iso.split('-');
      return `${day}/${month}/${year}`;
    }

    function updatePreview() {
      pNamePreview.textContent = patientName.value || '[Nome do paciente]';
      pDocPreview.textContent = documentInput.value || '[Documento]';
      pDatePreview.textContent = formatDateBR(issueDate.value);
      pDaysPreview.textContent = daysOff.value || '0';
      pNotesPreview.textContent = notes.value || '[Observações e diagnóstico]';
      doctorPreview.textContent = doctorName.value || 'Nome do médico';
      crmPreview.textContent = 'CRM: ' + (crm.value || '000000');
      documentDate.textContent = 'Data: ' + formatDateBR(issueDate.value);
    }

    document.getElementById('updateBtn').addEventListener('click', updatePreview);

    signatureUpload.addEventListener('change', e => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          signaturePreview.src = ev.target.result;
          signaturePreview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });

    document.getElementById('savePngBtn').addEventListener('click', async () => {
      const paper = document.getElementById('paper');
      updatePreview();
      try {
        if (document.fonts && document.fonts.ready) await document.fonts.ready;
        const canvas = await html2canvas(paper, { scale: 2, useCORS: true, allowTaint: true, backgroundColor: null });
        canvas.toBlob(blob => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'atestado.png';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        }, 'image/png');
      } catch(err) {
        console.error(err);
        alert('Falha ao gerar PNG. Verifique se as imagens (assinatura ou logo) estão acessíveis e use conexão HTTPS.');
      }
    });

    // Inicializa com data atual
    issueDate.value = new Date().toISOString().split('T')[0];
    updatePreview();
  </script>
</body>
</html>
